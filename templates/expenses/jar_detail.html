{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container my-5">
    <h2 class="text-center mb-4 text-primary">{{ jar.name }}</h2>

    <div class="row">
        <!-- Bi·ªÉu ƒë·ªì -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <canvas id="expenseChart" width="300" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- T·ªïng quan -->
        <div class="col-md-6">
            <div class="card shadow-sm border-0 mb-3">
                <div class="card-body">
                    <h5 class="card-title">T·ªïng quan h≈©</h5>
                    <p><strong>Ng√¢n s√°ch:</strong> <span class="text-success">{{ jar.total_budget }} ƒë</span></p>
                    <p><strong>ƒê√£ chi:</strong> <span class="text-danger">{{ jar.current_spent }} ƒë</span></p>
                    <p><strong>C√≤n l·∫°i:</strong> <span class="text-primary">{{ jar.remaining_budget }} ƒë</span></p>
                    <p><strong>Th√†nh vi√™n:</strong> 
                        {% for member in jar.members.all %}
                            <span class="badge bg-info text-dark">{{ member.username }}</span>
                        {% empty %}
                            <span class="text-muted">Ch·ªâ m√¨nh b·∫°n</span>
                        {% endfor %}
                    </p>
                    <a href="{% url 'edit_jar' jar.id %}" class="btn btn-sm btn-outline-warning">‚úèÔ∏è S·ª≠a h≈©</a>
                    <a href="{% url 'delete_jar' jar.id %}" class="btn btn-sm btn-outline-danger">üóëÔ∏è X√≥a h≈©</a>S
                    <a href="{% url 'share_jar' jar.id %}" class="btn btn-sm btn-outline-success">üë• Chia s·∫ª</a>
                </div>
            </div>
        </div>
    </div>

    <hr>

    <!-- Giao d·ªãch -->
    <h4 class="mt-4 mb-3">Giao d·ªãch trong h≈©</h4>
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <table class="table table-striped mb-0">
                <thead class="table-primary">
                    <tr>
                        <th>Ng√†y</th>
                        <th>H·∫°ng m·ª•c</th>
                        <th>S·ªë ti·ªÅn</th>
                        <th>M√¥ t·∫£</th>
                    </tr>
                </thead>
                <tbody>
                    {% for expense in expenses %}
                    <tr>
                        <td>{{ expense.date }}</td>
                        <td>{{ expense.category }}</td>
                        <td>{{ expense.amount }} ƒë</td>
                        <td>{{ expense.description }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center text-muted">Ch∆∞a c√≥ giao d·ªãch n√†o</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ChartJS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('expenseChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['ƒê√£ d√πng', 'C√≤n l·∫°i'],
            datasets: [{
                label: 'Chi ti√™u',
                data: [
                    {{ jar.current_spent|default_if_none:0|floatformat:"0" }},
                    {{ jar.remaining_budget|default_if_none:0|floatformat:"0" }}
                ],
                backgroundColor: ['#f87171', '#60a5fa'],
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const value = context.parsed;
                            const percent = ((value / total) * 100).toFixed(1);
                            return `${context.label}: ${value} ƒë (${percent}%)`;
                        }
                    }
                },
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
</script>
{% endblock %}
